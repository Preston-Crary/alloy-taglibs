<?xml version="1.0"?>

<project name="build-common-web" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-common.xml" />

	<property name="temp.dir" value="${project.dir}/_temp" />

	<target name="clean">
		<delete dir="docroot/WEB-INF/classes" />
		<delete file="${war.file}.war" failonerror="false" />
		<delete dir="${temp.dir}" />
	</target>

	<target name="compile">
	</target>

	<target name="deploy" depends="clean, compile">
		<var name="from.dir" value="docroot"/>
		<property name="war.file.dest" value="${app.server.portal.dir}" />

		<if>
			<equals arg1="${deploy.liferay}" arg2="true" />
			<then>
				<mkdir dir="${temp.dir}"/>

				<copy todir="${temp.dir}" preservelastmodified="true">
					<fileset dir="docroot" excludes="html/demos/**" />
				</copy>

				<copy todir="${temp.dir}/WEB-INF/tld/alloy" preservelastmodified="true">
					<fileset dir="${project.dir}/alloy-taglib/src/META-INF" includes="*.tld" />
				</copy>

				<antcall target="prepare-liferay-deploy" />

				<var name="from.dir" value="${temp.dir}"/>
			</then>
			<else>
				<copy todir="${project.dir}/alloy-web/docroot/WEB-INF/lib">
					<fileset dir="${project.dir}/lib/application" includes="*.jar" />
				</copy>
			</else>
		</if>

		<copy todir="${project.dir}/alloy-web/docroot/WEB-INF/lib">
			<fileset dir="${project.dir}/lib/liferay" includes="*.jar" />
		</copy>

		<copy todir="${war.file.dest}" preservelastmodified="true">
			<fileset dir="${from.dir}" excludes="web.xml" />
		</copy>

		<delete dir="${temp.dir}" />
	</target>

	<target name="prepare-liferay-deploy">
		<replace dir="${temp.dir}">
		  <include name="**/*.jsp"/>

		  <replacetoken><![CDATA[alloy-util:script]]></replacetoken>
		  <replacevalue><![CDATA[aui:script]]></replacevalue>
		</replace>

		<echo file="${temp.dir}/html/taglib/alloy/init.jsp" append="yes">
		<![CDATA[
			<%@ taglib uri="http://liferay.com/tld/aui" prefix="aui" %>
		]]>
		</echo>
	</target>

	<target name="war" depends="compile">
	</target>
</project>